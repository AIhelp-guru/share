<html>
<body>
  <div style="position:fixed;background:white;height:auto">
    <br><input id="lw" placeholder="linewidth"/>
    <br><input id="ls" placeholder="linespacing"/>
    <br><input id="an" placeholder="angle"/>
    <button id="go" onclick="redraw()">Go</button><br>
  </div>
    <img id="sourceImage"  />
    <div id="painting"></div>
<script>function convertToLineHalftone(img, maxLineWidth, xlineSpacing,ylineSpacing, angle) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  canvas.width = img.width;
  canvas.height = img.height;

  // Draw the original image on the canvas
  ctx.drawImage(img, 0, 0);

  // Get the image data
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  // Clear the canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = 'black';

  // Convert angle to radians
  const angleRadians = angle * Math.PI / 180;

  // Loop through the image by lineSpacing
  for (let y = 0; y < canvas.height; y += lineSpacing) {
    for (let x = 0; x < canvas.width; x += lineSpacing) {
      // Calculate average darkness of the region
      let average = 0;
      let pixelCount = 0;
      for (let dy = 0; dy < ylineSpacing; dy++) {
        for (let dx = 0; dx < xlineSpacing; dx++) {
          const index = ((y + dy) * canvas.width + (x + dx)) * 4;
          // Use red channel for grayscale image's darkness
          average += data[index];
          pixelCount++;
        }
      }
      average /= pixelCount;

      // Adjust lineWidth based on darkness (darker = thicker line)
      const localLineWidth = (1 - average / 255) * maxLineWidth;

      // Set up drawing for each line with rotation and position
      ctx.save();
      ctx.translate(x + xlineSpacing / 2, y + ylineSpacing / 2); // Center rotation in each cell
      ctx.rotate(angleRadians);

      // Draw line with dynamic width
      ctx.fillRect(-localLineWidth / 2, -ylineSpacing / 2, localLineWidth, ylineSpacing);
      
      ctx.restore();
    }
  }

  return canvas;
}



// The rest of your JavaScript remains the same.

function redraw(){
     const img = document.getElementById('sourceImage');
     const lw = parseInt(document.getElementById('lw').value);
     const ls = parseInt(document.getElementById('ls').value);
     const an = parseInt(document.getElementById('an').value);
      ha = convertToLineHalftone(img, lw, ls, an);
      console.log(ha);
     document.getElementById("painting").innerHTML = "";
       document.getElementById("painting").appendChild(ha);
}
// Usage:
// Assuming you have an <img id="sourceImage" src="image.jpg">
// and you want to transform it and put the result into <canvas id="halftoneCanvas">
window.onload = function() {
  const img = document.getElementById('sourceImage');
  img.onload = function() {
      
    const halftoneCanvas = convertToLineHalftone(img, 2, 2, 45);
    document.getElementById("painting").innerHTML = "";
       document.getElementById("painting").appendChild(halftoneCanvas);
  };
  img.src = 'sample.jpg'; // Set the source to your image
};
</script>
</body>
</html>
