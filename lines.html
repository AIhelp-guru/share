<!DOCTYPE html>
<html>
<body>
  <div style="position:fixed; background:white; height:auto;">
    <br><input id="lw" placeholder="Max Line Width"/>
    <br><input id="lsx" placeholder="Line Spacing X"/>
    <br><input id="lsy" placeholder="Line Spacing Y"/>
    <br><input id="an" placeholder="Angle"/>
    <br><input id="imagesrc" placeholder="Image Source" onblur="loadImage()"/>
    <button id="go" onclick="redraw()">Go</button><br>
  </div>
    <img id="sourceImage" style="display:none;"/>
    <div id="painting"></div>
<script>
function convertToLineHalftone(img, maxLineWidth, xLineSpacing, yLineSpacing, angle) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  canvas.width = img.width;
  canvas.height = img.height;

  // Draw the original image on the canvas
  ctx.drawImage(img, 0, 0);

  // Get the image data
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  // Clear the canvas
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = 'black';

  // Convert angle to radians
  const angleRadians = angle * Math.PI / 180;

  // Loop through the image according to xLineSpacing and yLineSpacing
  for (let y = 0; y < canvas.height; y += yLineSpacing) {
    for (let x = 0; x < canvas.width; x += xLineSpacing) {
      // Calculate average darkness of the region
      let average = 0;
      let pixelCount = 0;
      for (let dy = 0; dy < yLineSpacing; dy++) {
        for (let dx = 0; dx < xLineSpacing; dx++) {
          const index = ((y + dy) * canvas.width + (x + dx)) * 4;
          // Use red channel for grayscale image's darkness
          average += data[index];
          pixelCount++;
        }
      }
      average /= pixelCount;

      // Adjust lineWidth based on darkness (darker = thicker line)
      const localLineWidth = (1 - average / 255) * maxLineWidth;

      // Set up drawing for each line with rotation and position
      ctx.save();
      ctx.translate(x + xLineSpacing / 2, y + yLineSpacing / 2); // Center rotation in each cell
      ctx.rotate(angleRadians);

      // Draw line with dynamic width
      ctx.fillRect(-localLineWidth / 2, -yLineSpacing / 2, localLineWidth, yLineSpacing);
      
      ctx.restore();
    }
  }

  return canvas;
}
function loadImage(){
  s = document.getElementById("imagesrc").value;
  const img = document.getElementById('sourceImage');
  img.src = s;

}
function redraw(){
     const img = document.getElementById('sourceImage');
     const lw = parseInt(document.getElementById('lw').value) || 2; // Default to 2 if not specified
     const lsx = parseInt(document.getElementById('lsx').value) || 2; // Default to 2 if not specified
     const lsy = parseInt(document.getElementById('lsy').value) || 2; // Default to 2 if not specified
     const an = parseFloat(document.getElementById('an').value) || 0; // Default to 0 if not specified
     const ha = convertToLineHalftone(img, lw, lsx, lsy, an);
     document.getElementById("painting").innerHTML = ""; // Clear existing content
     document.getElementById("painting").appendChild(ha); // Add new canvas
}

window.onload = function() {
  const img = document.getElementById('sourceImage');
  img.onload = function() {
    redraw(); // Initially draw the halftone image
  };
  img.src = 'sample.jpg'; // Set the source to your image
};
</script>
</body>
</html>
